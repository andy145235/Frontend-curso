<div class="dashboard-container">

  <header class="app-header">
    <div class="header-content">
      <div class="header-left">
        <h1>
          ğŸ“ Plataforma de Cursos
          <span class="badge-pro" [style.background]="isAdmin ? '#4f46e5' : '#10b981'">
            {{ isAdmin ? 'Admin' : 'Estudiante' }}
          </span>
        </h1>
        <p>Gestiona tu catÃ¡logo educativo de forma eficiente</p>
      </div>
      <!-- NUEVO: acciones de usuario -->
      <div class="header-right">
        <button class="btn-logout" (click)="logout()">
          ğŸšª <span>Logout</span>
        </button>
      </div>
      
    </div>
  </header>

  <div class="content-wrapper">

    <aside class="sidebar-section" *ngIf="isAdmin">
      <div class="card form-card">
        <div class="card-header">
          <h3>{{ esEdicion ? 'âœï¸ Editar Curso' : 'âœ¨ Nuevo Curso' }}</h3>
        </div>

        <div class="form-body">
          <div class="form-group">
            <label>TÃ­tulo</label>
            <input
              type="text"
              [(ngModel)]="cursoActual.titulo"
              placeholder="Ej: Angular Avanzado"
              class="input-modern">
          </div>

          <div class="form-group">
            <label>Instructor ğŸ‘¨â€ğŸ«</label>
            <input
              type="text"
              [(ngModel)]="cursoActual.instructor"
              placeholder="Nombre del Docente"
              class="input-modern">
          </div>

          <div class="form-group">
            <label>CategorÃ­a</label>
            <input
              type="text"
              [(ngModel)]="cursoActual.categoria"
              placeholder="Ej: Frontend"
              class="input-modern">
          </div>

          <div class="form-row">
            <div class="form-group half">
              <label>Nivel</label>
              <select [(ngModel)]="cursoActual.nivel" class="input-modern">
                <option value="Basico">ğŸŸ¢ BÃ¡sico</option>
                <option value="Intermedio">ğŸŸ¡ Intermedio</option>
                <option value="Avanzado">ğŸ”´ Avanzado</option>
              </select>
            </div>
            <div class="form-group half">
              <label>Estado</label>
              <select [(ngModel)]="cursoActual.estado" class="input-modern">
                <option value="Activo">Activo</option>
                <option value="Inactivo">Inactivo</option>
              </select>
            </div>
          </div>

          <div class="form-group">
            <label>DescripciÃ³n</label>
            <textarea
              [(ngModel)]="cursoActual.descripcion"
              rows="3"
              placeholder="Breve resumen..."
              class="input-modern"></textarea>
          </div>

          <div class="form-actions">
            <button (click)="guardarCurso()" class="btn btn-primary full-width">
              {{ esEdicion ? 'Actualizar Cambios' : 'Crear Curso' }}
            </button>
            <button
              *ngIf="esEdicion"
              (click)="limpiarFormulario()"
              class="btn btn-outline full-width mt-2">
              Cancelar
            </button>
          </div>
        </div>
      </div>
    </aside>

    <main class="main-section" [style.flex]="isAdmin ? '2.5' : '1'">

      <div class="card search-card">
        <div class="search-bar">
          <span class="search-icon">ğŸ”</span>
          <input
            type="text"
            [(ngModel)]="filtroTitulo"
            (ngModelChange)="onSearchInput()"
            placeholder="Buscar cursos..."
            class="search-input">
        </div>
        <div class="filters-row">
          <button (click)="limpiarFiltros()" class="btn btn-ghost">ğŸ”„ Limpiar</button>
        </div>
      </div>

      <div class="courses-grid" *ngIf="cursosFiltrados.length > 0; else noData">
        <div *ngFor="let curso of cursosFiltrados" class="course-card fade-in">
          <div
            class="course-status-indicator"
            [class.active]="curso.estado === 'Activo'"></div>

          <div class="course-content">
            <div class="course-top">
              <span class="badge category">{{ curso.categoria }}</span>
              <span class="badge level">{{ curso.nivel }}</span>
              <span *ngIf="curso.yaInscrito" class="badge enrolled">âœ… Inscrito</span>
            </div>

            <h3 class="course-title">{{ curso.titulo }}</h3>

            <p
              class="instructor-text"
              *ngIf="curso.instructor"
              style="color: #64748b; font-size: 0.9rem; margin-bottom: 5px;">
              ğŸ‘¨â€ğŸ« {{ curso.instructor }}
            </p>

            <p class="course-desc">{{ curso.descripcion }}</p>

            <div class="quota-section">
              <div class="quota-info">
                <small>
                  Cupos:
                  <strong>{{ curso.inscritosActuales || 0 }} / {{ curso.cuposMaximos || 20 }}</strong>
                </small>

                <div *ngIf="isAdmin" class="quota-controls">
                  <button
                    (click)="cambiarCupos(curso, -1)"
                    class="btn-mini"
                    title="Restar cupo">-</button>
                  <button
                    (click)="cambiarCupos(curso, 1)"
                    class="btn-mini"
                    title="Sumar cupo">+</button>
                </div>

                <small
                  [style.color]="(curso.inscritosActuales || 0) >= (curso.cuposMaximos || 20) ? 'red' : 'green'">
                  {{
                    (curso.inscritosActuales || 0) >= (curso.cuposMaximos || 20)
                      ? 'Â¡Lleno!' : 'Disponible'
                  }}
                </small>
              </div>

              <div class="progress-bar-bg">
                <div
                  class="progress-bar-fill"
                  [style.width.%]="((curso.inscritosActuales || 0) / (curso.cuposMaximos || 20)) * 100"></div>
              </div>
            </div>
          </div>

          <div class="course-footer">
            <div class="main-action">
              <button
                *ngIf="curso.yaInscrito"
                (click)="irAClase(curso)"
                class="btn btn-sm btn-success full-width">
                â–¶ Ir a Clases
              </button>

              <button
                *ngIf="!curso.yaInscrito && (curso.inscritosActuales || 0) < (curso.cuposMaximos || 20)"
                (click)="inscribirse(curso)"
                class="btn btn-sm btn-primary full-width">
                Inscribirme
              </button>

              <button
                *ngIf="!curso.yaInscrito && (curso.inscritosActuales || 0) >= (curso.cuposMaximos || 20)"
                disabled
                class="btn btn-sm btn-disabled full-width">
                â›” Agotado
              </button>
            </div>

            <div class="actions-right">
              <button
                (click)="verTemario(curso)"
                class="btn-icon blue"
                title="Ver Temario">
                ğŸ‘ï¸
              </button>

              <button
                (click)="irAResenas(curso)"
                class="btn-icon orange"
                title="Ver ReseÃ±as">
                â­
              </button>

              <ng-container *ngIf="isAdmin">
                <button
                  (click)="editarCurso(curso)"
                  class="btn-icon yellow"
                  title="Editar">
                  âœï¸
                </button>
                <button
                  (click)="eliminarCurso(curso.idCurso!)"
                  class="btn-icon red"
                  title="Eliminar">
                  ğŸ—‘ï¸
                </button>
              </ng-container>
            </div>
          </div>
        </div>
      </div>

      <ng-template #noData>
        <p class="empty-state">No hay cursos.</p>
      </ng-template>
    </main>
  </div>
</div>

<!-- MODAL TEMARIO -->
<div *ngIf="cursoSeleccionado" class="modal-overlay fade-in">
  <div class="modal-modern">

    <div class="modal-header">
      <div>
        <h2>{{ cursoSeleccionado.titulo }}</h2>
        <p class="text-muted">{{ cursoSeleccionado.descripcion }}</p>
      </div>
      <button (click)="cerrarTemario()" class="close-btn">âœ•</button>
    </div>

    <div class="modal-body-scroll">

      <div class="modal-actions-row" *ngIf="isAdmin">
        <button (click)="agregarModulo()" class="btn btn-primary">
          + Nuevo MÃ³dulo
        </button>
        <button
          (click)="toggleModoOrden()"
          class="btn"
          [class.btn-warning]="!modoOrden"
          [class.btn-success]="modoOrden">
          {{ modoOrden ? 'âœ… Terminar Orden' : 'ğŸ”ƒ Ordenar' }}
        </button>
      </div>

      <h4 class="section-title">Contenido del Curso</h4>

      <div cdkDropList (cdkDropListDropped)="dropModulo($event)" class="modules-list">

        <div
          *ngFor="let modulo of cursoSeleccionado.modulos"
          class="module-item"
          cdkDrag
          [cdkDragDisabled]="!modoOrden">

          <div class="module-header" (click)="toggleModulo(modulo)">
            <div class="header-left">
              <span *ngIf="modoOrden" class="drag-handle" cdkDragHandle>â˜°</span>

              <span class="chevron">{{ modulo.isOpen ? 'â–¼' : 'â–¶' }}</span>
              <span class="module-title">ğŸ“‚ {{ modulo.titulo }}</span>
            </div>

            <div *ngIf="isAdmin && !modoOrden" class="module-actions">
              <button
                (click)="agregarLeccion(modulo.idModulo!, modulo); $event.stopPropagation()"
                class="btn-mini">
                Add LecciÃ³n
              </button>
              <button
                (click)="editarModulo(modulo); $event.stopPropagation()"
                class="btn-mini edit">
                âœï¸
              </button>
              <button
                (click)="eliminarModulo(modulo.idModulo!); $event.stopPropagation()"
                class="btn-mini red">
                ğŸ—‘ï¸
              </button>
            </div>
          </div>

          <div
            class="lessons-list"
            *ngIf="modulo.isOpen"
            cdkDropList
            (cdkDropListDropped)="dropLeccion($event, modulo)">

            <div
              *ngFor="let leccion of modulo.lecciones; trackBy: trackByFn"
              class="lesson-item"
              cdkDrag
              [cdkDragDisabled]="!modoOrden">

              <div class="lesson-content-row">
                <span *ngIf="modoOrden" class="drag-handle-sm" cdkDragHandle>â ¿</span>

                <span class="lesson-icon">ğŸ“„</span>
                <span class="lesson-name">{{ leccion.titulo }}</span>
              </div>

              <div *ngIf="isAdmin && !modoOrden" class="lesson-actions">
                <button
                  (click)="editarLeccion(leccion, modulo.idModulo!)"
                  class="btn-icon-tiny"
                  title="Editar">
                  âœï¸
                </button>

                <button
                  (click)="eliminarLeccion(leccion)"
                  class="btn-icon-tiny delete-btn"
                  title="Eliminar">
                  ğŸ—‘ï¸
                </button>
              </div>

            </div>

          </div>
        </div>

      </div>

    </div>
  </div>
</div>
