<div *ngIf="!vistaClase && !vistaResenas" class="dashboard-container">

  <header class="app-header">
    <div class="header-content">
      <h1>ğŸ“ Plataforma de Cursos <span class="badge-pro" [style.background]="isAdmin ? '#4f46e5' : '#10b981'">{{ isAdmin ? 'Admin' : 'Estudiante' }}</span></h1>
      <p>Gestiona tu catÃ¡logo educativo de forma eficiente</p>
    </div>
  </header>

  <div class="content-wrapper">

    <aside class="sidebar-section" *ngIf="isAdmin">
      <div class="card form-card">
        <div class="card-header">
          <h3>{{ esEdicion ? 'âœï¸ Editar Curso' : 'âœ¨ Nuevo Curso' }}</h3>
        </div>

        <div class="form-body">
          <div class="form-group">
            <label>TÃ­tulo</label>
            <input type="text" [(ngModel)]="cursoActual.titulo" placeholder="Ej: Angular Avanzado" class="input-modern">
          </div>

          <div class="form-group">
            <label>Instructor ğŸ‘¨â€ğŸ«</label>
            <input type="text" [(ngModel)]="cursoActual.instructor" placeholder="Nombre del Docente" class="input-modern">
          </div>

          <div class="form-group">
            <label>CategorÃ­a</label>
            <input type="text" [(ngModel)]="cursoActual.categoria" placeholder="Ej: Frontend" class="input-modern">
          </div>

          <div class="form-row">
            <div class="form-group half">
              <label>Nivel</label>
              <select [(ngModel)]="cursoActual.nivel" class="input-modern">
                <option value="Basico">ğŸŸ¢ BÃ¡sico</option>
                <option value="Intermedio">ğŸŸ¡ Intermedio</option>
                <option value="Avanzado">ğŸ”´ Avanzado</option>
              </select>
            </div>
            <div class="form-group half">
              <label>Estado</label>
              <select [(ngModel)]="cursoActual.estado" class="input-modern">
                <option value="Activo">Activo</option>
                <option value="Inactivo">Inactivo</option>
              </select>
            </div>
          </div>

          <div class="form-group">
            <label>DescripciÃ³n</label>
            <textarea [(ngModel)]="cursoActual.descripcion" rows="3" placeholder="Breve resumen..." class="input-modern"></textarea>
          </div>

          <div class="form-actions">
            <button (click)="guardarCurso()" class="btn btn-primary full-width">
              {{ esEdicion ? 'Actualizar Cambios' : 'Crear Curso' }}
            </button>
            <button *ngIf="esEdicion" (click)="limpiarFormulario()" class="btn btn-outline full-width mt-2">
              Cancelar
            </button>
          </div>
        </div>
      </div>
    </aside>

    <main class="main-section" [style.flex]="isAdmin ? '2.5' : '1'">

      <div class="card search-card">
        <div class="search-bar">
          <span class="search-icon">ğŸ”</span>
          <input type="text" [(ngModel)]="filtroTitulo" (ngModelChange)="onSearchInput()" placeholder="Buscar cursos..." class="search-input">
        </div>
        <div class="filters-row">
          <button (click)="limpiarFiltros()" class="btn btn-ghost">ğŸ”„ Limpiar</button>
        </div>
      </div>

      <div class="courses-grid" *ngIf="cursosFiltrados.length > 0; else noData">
        <div *ngFor="let curso of cursosFiltrados" class="course-card fade-in">
          <div class="course-status-indicator" [class.active]="curso.estado === 'Activo'"></div>

          <div class="course-content">
            <div class="course-top">
              <span class="badge category">{{ curso.categoria }}</span>
              <span class="badge level">{{ curso.nivel }}</span>
              <span *ngIf="curso.yaInscrito" class="badge enrolled">âœ… Inscrito</span>
            </div>


            <h3 class="course-title">{{ curso.titulo }}</h3>
            <p class="instructor-text" *ngIf="curso.instructor" style="color: #64748b; font-size: 0.9rem; margin-bottom: 5px;">
              ğŸ‘¨â€ğŸ« {{ curso.instructor }}
            </p>
            <p class="course-desc">{{ curso.descripcion }}</p>

            <div class="quota-section">
              <div class="quota-info">
                <small>Cupos: <strong>{{ curso.inscritosActuales || 0 }} / {{ curso.cuposMaximos || 20 }}</strong></small>

                <div *ngIf="isAdmin" class="quota-controls">
                  <button (click)="cambiarCupos(curso, -1)" class="btn-mini" title="Restar cupo">-</button>
                  <button (click)="cambiarCupos(curso, 1)" class="btn-mini" title="Sumar cupo">+</button>
                </div>

                <small [style.color]="(curso.inscritosActuales || 0) >= (curso.cuposMaximos || 20) ? 'red' : 'green'">
                  {{ (curso.inscritosActuales || 0) >= (curso.cuposMaximos || 20) ? 'Â¡Lleno!' : 'Disponible' }}
                </small>
              </div>
              <div class="progress-bar-bg">
                <div class="progress-bar-fill" [style.width.%]="((curso.inscritosActuales || 0) / (curso.cuposMaximos || 20)) * 100"></div>
              </div>
            </div>
          </div>

          <div class="course-footer">
            <div class="main-action">
              <button *ngIf="curso.yaInscrito" (click)="irAClase(curso)" class="btn btn-sm btn-success full-width">
                â–¶ Ir a Clases
              </button>

              <button *ngIf="!curso.yaInscrito && (curso.inscritosActuales || 0) < (curso.cuposMaximos || 20)" (click)="inscribirse(curso)" class="btn btn-sm btn-primary full-width">
                Inscribirme
              </button>

              <button *ngIf="!curso.yaInscrito && (curso.inscritosActuales || 0) >= (curso.cuposMaximos || 20)" disabled class="btn btn-sm btn-disabled full-width">
                â›” Agotado
              </button>
            </div>

            <div class="actions-right">

              <button (click)="verTemario(curso)" class="btn-icon blue" title="Ver Temario">
                ğŸ‘ï¸
              </button>
              <button (click)="irAResenas(curso)" class="btn-icon orange" title="Ver ReseÃ±as">â­</button>

              <ng-container *ngIf="isAdmin">
                <button (click)="editarCurso(curso)" class="btn-icon yellow" title="Editar">âœï¸</button>
                <button (click)="eliminarCurso(curso.idCurso!)" class="btn-icon red" title="Eliminar">ğŸ—‘ï¸</button>
              </ng-container>
            </div>
          </div>
        </div>
      </div>
      <ng-template #noData><p class="empty-state">No hay cursos.</p></ng-template>
    </main>
  </div>
</div>

<div *ngIf="vistaClase && cursoEnClase" class="classroom-container fade-in">

  <aside class="classroom-sidebar">
    <div class="sidebar-header">
      <button (click)="volverAlHome()" class="btn-back">â¬… Volver</button>
      <button (click)="irAResenas(cursoEnClase!)" class="btn-reviews-sidebar">â­ Ver Opiniones</button>
      <h3>{{ cursoEnClase.titulo }}</h3>

      <div class="progress-container">
        <div class="progress-label">
          <span>Tu avance:</span>
          <strong>{{ progresoPorcentaje }}%</strong>
        </div>
        <div class="progress-track">
          <div class="progress-fill" [style.width.%]="progresoPorcentaje"></div>
        </div>
      </div>

      <p class="instructor-label">ğŸ‘¨â€ğŸ« Por: {{ cursoEnClase.instructor || 'Docente por asignar' }}</p>
    </div>

    <div class="modules-scroll">
      <div *ngFor="let mod of cursoEnClase.modulos; let i = index" class="module-group">

        <div class="mod-title clickable" (click)="mod.isOpen = !mod.isOpen">
          <span class="chevron">{{ mod.isOpen ? 'â–¼' : 'â–¶' }}</span>
          ğŸ“‚ {{ mod.titulo }}
        </div>

        <div class="lessons-container" [class.show]="mod.isOpen">
          <div *ngFor="let lec of mod.lecciones"
               (click)="seleccionarLeccion(lec)"
               class="lesson-item"
               [class.active]="leccionActual === lec">

            <span class="status-icon" [class.completed]="esCompletada(lec.idLeccion!)">
               {{ esCompletada(lec.idLeccion!) ? 'âœ…' : 'â–¶' }}
            </span>

            <span class="lesson-text">{{ lec.titulo }}</span>
          </div>



          <div *ngIf="!mod.lecciones?.length" class="no-lessons">
            (Sin contenido)
          </div>
        </div>

      </div>
    </div>


    <div class="sidebar-footer">
      <button (click)="abandonarCurso()"
              [disabled]="cargandoAbandonar"
              class="btn-abandonar"
              [class.loading]="cargandoAbandonar">
        <span *ngIf="!cargandoAbandonar">ğŸšª Abandonar Curso</span>
        <span *ngIf="cargandoAbandonar">â³ Procesando...</span>
      </button>
    </div>
  </aside>

  <main class="classroom-content">
    <div *ngIf="leccionActual; else welcomeMsg" class="content-player">

      <div class="cinema-mode">
        <div class="video-wrapper" *ngIf="leccionActual.videoUrl">
          <iframe [src]="leccionActual.videoUrl | safe"
                  title="Video Player" frameborder="0"
                  allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture"
                  allowfullscreen>
          </iframe>
        </div>

        <div *ngIf="!leccionActual.videoUrl" class="video-placeholder-modern">
          <div class="icon-book">ğŸ“–</div>
          <p>Esta lecciÃ³n es de lectura. Revisa la descripciÃ³n abajo.</p>
        </div>
      </div>

      <div class="lesson-controls">
        <div class="lesson-info-header">
          <h2>{{ leccionActual.titulo }}</h2>
          <span class="badge-status" [class.done]="esCompletada(leccionActual.idLeccion!)">
            {{ esCompletada(leccionActual.idLeccion!) ? 'COMPLETADO' : 'PENDIENTE' }}
          </span>
        </div>

        <button (click)="marcarYContinuar()" class="btn-next-lesson">
          <span>{{ esCompletada(leccionActual.idLeccion!) ? 'Continuar' : 'Completar y Siguiente' }}</span>
          <span class="arrow">â†’</span>
        </button>
      </div>

      <hr class="divider">

      <div class="lesson-details">
        <div class="detail-section">
          <h3>ğŸ“ DescripciÃ³n</h3>
          <p class="text-content">{{ leccionActual.contenido }}</p>
        </div>

        <div class="detail-section" *ngIf="leccionActual.pdfUrl">
          <h3>ğŸ“‚ Recursos Descargables</h3>
          <a [href]="leccionActual.pdfUrl" target="_blank" class="resource-card">
            <span class="file-icon">ğŸ“„</span>
            <div>
              <strong>Material de Clase (PDF)</strong>
              <small>Clic para ver o descargar</small>
            </div>
          </a>
        </div>
      </div>

    </div>

    <ng-template #welcomeMsg>
      <div class="empty-state-pro">
        <img src="https://cdn-icons-png.flaticon.com/512/7480/7480597.png" alt="Start" width="150">
        <h1>Â¡EstÃ¡s listo para aprender! ğŸš€</h1>
        <p>Selecciona la primera lecciÃ³n del menÃº a la izquierda para comenzar tu camino.</p>
      </div>
    </ng-template>
  </main>
</div>

<div *ngIf="cursoSeleccionado" class="modal-overlay fade-in">
  <div class="modal-modern">

    <div class="modal-header">
      <div>
        <h2>{{ cursoSeleccionado.titulo }}</h2>
        <p class="text-muted">{{ cursoSeleccionado.descripcion }}</p>
      </div>
      <button (click)="cerrarTemario()" class="close-btn">âœ•</button>
    </div>

    <div class="modal-body-scroll">

      <div class="modal-actions-row" *ngIf="isAdmin">
        <button (click)="agregarModulo()" class="btn btn-primary">+ Nuevo MÃ³dulo</button>
        <button (click)="toggleModoOrden()" class="btn"
                [class.btn-warning]="!modoOrden"
                [class.btn-success]="modoOrden">
          {{ modoOrden ? 'âœ… Terminar Orden' : 'ğŸ”ƒ Ordenar' }}
        </button>
      </div>

      <h4 class="section-title">Contenido del Curso</h4>

      <div cdkDropList (cdkDropListDropped)="dropModulo($event)" class="modules-list">

        <div *ngFor="let modulo of cursoSeleccionado.modulos" class="module-item" cdkDrag [cdkDragDisabled]="!modoOrden">

          <div class="module-header" (click)="toggleModulo(modulo)">
            <div class="header-left">
              <span *ngIf="modoOrden" class="drag-handle" cdkDragHandle>â˜°</span>

              <span class="chevron">{{ modulo.isOpen ? 'â–¼' : 'â–¶' }}</span>
              <span class="module-title">ğŸ“‚ {{ modulo.titulo }}</span>
            </div>

            <div *ngIf="isAdmin && !modoOrden" class="module-actions">
              <button (click)="agregarLeccion(modulo.idModulo!, modulo); $event.stopPropagation()" class="btn-mini">Add LecciÃ³n</button>
              <button (click)="editarModulo(modulo); $event.stopPropagation()" class="btn-mini edit">âœï¸</button>
              <button (click)="eliminarModulo(modulo.idModulo!); $event.stopPropagation()" class="btn-mini red">ğŸ—‘ï¸</button>
            </div>
          </div>

          <div class="lessons-list" *ngIf="modulo.isOpen"
               cdkDropList (cdkDropListDropped)="dropLeccion($event, modulo)">

            <div *ngFor="let leccion of modulo.lecciones; trackBy: trackByFn"
                 class="lesson-item"
                 cdkDrag
                 [cdkDragDisabled]="!modoOrden">

              <div class="lesson-content-row">
                <span *ngIf="modoOrden" class="drag-handle-sm" cdkDragHandle>â ¿</span>

                <span class="lesson-icon">ğŸ“„</span>
                <span class="lesson-name">{{ leccion.titulo }}</span>
              </div>

              <div *ngIf="isAdmin && !modoOrden" class="lesson-actions">
                <button (click)="editarLeccion(leccion, modulo.idModulo!)" class="btn-icon-tiny" title="Editar">âœï¸</button>

                <button (click)="eliminarLeccion(leccion)" class="btn-icon-tiny delete-btn" title="Eliminar">ğŸ—‘ï¸</button>
              </div>

            </div>

        </div>
      </div>

    </div>
  </div>
 </div>

  // resenas
  <div *ngIf="vistaResenas" class="reviews-screen fade-in">

    <div class="reviews-top-bar">
      <button (click)="volverDeResenas()" class="btn-back-review">â¬… Volver a la Plataforma</button>
      <h2>â­ Opiniones del curso: {{ cursoSeleccionado.titulo }}</h2>
    </div>

    <div class="microservice-placeholder">
      <div class="placeholder-msg">
        <div style="font-size: 50px;">ğŸ§©</div>
        <h3>MÃ³dulo de ReseÃ±as Externo</h3>
       
      </div>
    </div>

  </div>
</div>
